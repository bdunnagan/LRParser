package org.xidget.parser.lr3.lr1;

import java.util.Collection;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Set;

import org.xidget.parser.lr3.Grammar;
import org.xidget.parser.lr3.Rule;

public class LR1Item
{
  public LR1Item( Rule rule, String la)
  {
    this.rule = rule;
    this.laList = new LinkedHashSet<String>();
    this.laList.add( la);
  }
  
  public LR1Item( Rule rule, Collection<String> la)
  {
    this.rule = rule;
    this.laList = new LinkedHashSet<String>();
    this.laList.addAll( la);
  }
  
  /**
   * @return Returns null or the symbol after the dot.
   */
  public String symbol()
  {
    if ( dot < rule.rhs().size())
      return rule.rhs().get( dot);
    return null;
  }
  
  /**
   * Compute the First() set for this item.  For example, if this item has the form,
   * [A -> u·Bv, a], then first(va) is computed.
   * @param grammar
   * @return Returns the list of terminals.
   */
  public Collection<String> first( Grammar grammar)
  {
    //
    // In the form, [A -> u·Bv, a], v may be more than one symbol.
    //
    List<String> rhs = rule.rhs();
    if ( dot < rhs.size())
    {
      List<String> v = rhs.subList( dot+1, rhs.size());
      List<String> result = grammar.first( v);
      if ( result.size() > 0) 
      {
        if ( result.remove( ""))
          result.addAll( laList);
        return result;
      }
    }
    
    return laList;
  }
  
  /**
   * Compute the epsilon-free First() set for this item.  For example, if this item has the form,
   * [A -> u·Bv, a], then eff(va) is computed.
   * @param grammar
   * @return Returns the list of terminals.
   */
  public Collection<String> eff( Grammar grammar)
  {
    //
    // In the form, [A -> u·Bv, a], v may be more than one symbol.
    //
    List<String> rhs = rule.rhs();
    if ( dot < rhs.size())
    {
      List<String> v = rhs.subList( dot+1, rhs.size());
      List<String> result = grammar.eff( v);
      if ( result.size() > 0) return result;
    }
    
    if ( !laList.contains( Grammar.epsilon) && !laList.contains( Grammar.finish)) return laList;
    
    Set<String> efla = new LinkedHashSet<String>( laList);
    efla.remove( Grammar.epsilon);
    efla.remove( Grammar.finish);
    
    return efla;
  }
  
  /**
   * Create a new LR0Item with the dot position incremented.
   * @return Returns null or the new LR0Item.
   */
  public LR1Item increment()
  {
    if ( dot < rule.rhs().size())
    {
      LR1Item item = new LR1Item( rule, laList);
      item.dot = dot + 1;
      return item;
    }
    return null;
  }
  
  /**
   * @return Returns true if the dot is at the end of the rhs.
   */
  public boolean complete()
  {
    return dot == rule.rhs().size();
  }
  
  /* (non-Javadoc)
   * @see java.lang.Object#equals(java.lang.Object)
   */
  @Override
  public boolean equals( Object object)
  {
    LR1Item item = (LR1Item)object;
    return item.rule == rule && item.dot == dot && item.laList.equals( laList);
  }

  /* (non-Javadoc)
   * @see java.lang.Object#hashCode()
   */
  @Override
  public int hashCode()
  {
    return rule.hashCode() + dot + laList.hashCode();
  }

  /* (non-Javadoc)
   * @see java.lang.Object#toString()
   */
  @Override
  public String toString()
  {
    StringBuilder sb = new StringBuilder();
    sb.append( '[');
    sb.append( rule.name());
    sb.append( " := ");
    
    int index = 0;
    for( String symbol: rule.rhs())
    {
      if ( symbol.matches( "\\s++")) symbol = String.format( "#%02X", (int)symbol.charAt( 0));
      sb.append( (index == dot)? '·': ' ');  
      sb.append( symbol);
      index++;
    }
    
    if ( dot == index) sb.append( '·');

    sb.append( ", ");
    for( String la: laList)
    {
      if ( la.matches( "\\s++")) la = String.format( "#%02X", (int)la.charAt( 0));
      sb.append( la);
      sb.append( '/');
    }
    sb.setLength( sb.length() - 1);
    
    sb.append( ']');
    
    return sb.toString();
  }

  public Rule rule;
  public int dot;
  public Set<String> laList;
}