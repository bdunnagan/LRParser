package org.xidget.parser.lr3;

import java.io.IOException;
import java.io.Reader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.xidget.parser.lr3.lr1.LR1;
import org.xidget.parser.lr3.lr1.LR1Item;

public class Parser
{
  /**
   * Create a Parser with the specified table generator and start state.
   * @param lr The table generator (for error reporting).
   * @param start The start state.
   */
  public Parser( LR1 lr, State start)
  {
    this( lr, start, 1024);
  }
  
  /**
   * Create a Parser with the specified table generator, start state and buffer size.
   * @param lr The table generator (for error reporting).
   * @param start The start state.
   * @param bufferSize The initial buffer size.
   */
  public Parser( LR1 lr, State start, int bufferSize)
  {
    this.lr = lr;
    dfa = new DFA( start);
    buffer = new char[ bufferSize];
  }

  /**
   * Parse the specified stream.
   * @param reader The stream.
   * @return Returns true if the parse is successful.
   */
  public boolean parse( Reader reader) throws IOException
  {
    dfa.reset();
    int preserve = 0;
    int read = 0;
    while( true)
    {
      read = reader.read( buffer, preserve, buffer.length - preserve);
      if ( read < 0)
      {
        buffer[ preserve] = Grammar.terminusChar;
        read = 1;
      }
      
      int consumed = dfa.parse( this, buffer, preserve, read);
      if ( consumed == -1) return false;
      if ( consumed == -2) return true;

      preserve += read - consumed;
      if ( preserve == buffer.length) 
      {
        buffer = Arrays.copyOf( buffer, buffer.length * 2);
      }
      else
      {
        System.arraycopy( buffer, consumed, buffer, 0, preserve);
      }
    }
  }
  
  /**
   * Called when a DFA errors.
   * @param dfa The DFA that errored.
   * @param index The stream index.
   * @param stack The current DFA stack.
   * @param sindex The current stack index.
   */
  protected void onError( DFA dfa, int index, State[] stack, int sindex)
  {
    System.out.printf( "%s Parsing error at line %d, column %d: \n", dfa, dfa.line(), dfa.column());
    
    System.out.printf( "Stack: \n");
    for( int i=sindex; i>=0; i--)
    {
      List<LR1Item> items = new ArrayList<LR1Item>( lr.itemSet( stack[ i]).kernel);
      System.out.printf( "%4d. %s\n", i, items.get( 0));
      for( int j=1; j<items.size(); j++)
      {
        System.out.printf( "      %s\n", items.get( j));
      }
      System.out.println();
    }
  }
  
  private LR1 lr;
  private DFA dfa;
  private char[] buffer;
}
